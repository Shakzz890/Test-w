<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shakzz TV Player - Dual Player Edition</title>
  
  <script src="https://ssl.p.jwpcdn.com/player/v/8.36.6/jwplayer.js"></script>
  <script>jwplayer.key = "ITWMv7t88JGzI0xPwW8I0+LveiXX9SWbfdmt0ArUSyc=";</script>
  
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.13/dist/shaka-player.ui.js"></script>
  
  <style>
    :root {
      --primary-color: royalblue;
      --primary-gradient: linear-gradient(to right, rgba(65, 105, 225, 0.75), rgba(0, 0, 0, 0));
      --panel-bg-left: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4));
      --panel-bg-right: linear-gradient(to left, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4));
      --text-light: #fff;
      --text-medium: #ccc;
      --border-color: #444;
    }
    * { font-family: Lucida Sans, Arial, Helvetica, sans-serif; outline: none; box-sizing: border-box; }
    html, body {
      overscroll-behavior: none; margin: 0; padding: 0; background-color: #000;
      font-size: 28px; -moz-user-select: none; -webkit-user-select: none;
      user-select: none; touch-action: none; overflow: hidden; height: 100%;
    }
    #jwplayer_container, #shaka_player_container { z-index: 1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    #shaka_player { width: 100%; height: 100%; }
    .fullscreen { width: 100%; height: 100%; position: fixed; top: 0; left: 0; }
    .HIDDEN { display: none !important; }

    #blur_overlay { z-index: 25; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
    #blur_overlay.visible { opacity: 1; }

    #channel_loader_overlay { z-index: 60; display: flex; justify-content: center; align-items: center; pointer-events: none; }
    .loader-content { text-align: center; color: var(--text-light); pointer-events: auto; }
    .loading-text { font-size: clamp(24px, 4vw, 32px); font-weight: bold; text-shadow: 2px 2px 5px #000; display: block; margin-bottom: 20px; }
    .loader-bar { width: 250px; height: 4px; background-color: rgba(255, 255, 255, 0.3); border-radius: 2px; position: relative; overflow: hidden; margin: 0 auto; }
    .loader-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: var(--primary-color); border-radius: 2px; animation: loading-bar-animation 1.5s linear infinite; }
    @keyframes loading-bar-animation { 0% { left: -50%; } 100% { left: 100%; } }

    #nav, #channel_settings {
      z-index: 31; position: fixed; top: 0; width: clamp(320px, 25vw, 400px); max-width: 90%;
      overflow: hidden; height: 100%; transition: transform 0.5s; font-size: clamp(18px, 2.5vw, 22px);
    }
    #nav { left: 0; transform: translateX(-100%); background-image: var(--panel-bg-left); }
    #channel_settings { right: 0; transform: translateX(100%); background-image: var(--panel-bg-right); }
    #nav.visible, #channel_settings.visible { transform: translateX(0); }

    #list_container { display: flex; width: 200%; height: 100%; color: var(--text-light); transition: transform 0.5s; transform: translateX(-50%); }
    #list_container.groups-opened { transform: translateX(0); }
    #group_list, #channel_list, #channel_settings_list { height: 100%; width: 50%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    h2.list_headline { margin: 20px 30px; font-size: clamp(24px, 3vw, 28px); color: var(--text-medium); }
    ul { list-style: none; margin: 0; padding: 0; }
    
    .panel-item {
      padding: 4px 20px; margin: 2px 0; white-space: nowrap; cursor: pointer;
      height: 50px; line-height: 50px; display: flex; align-items: center;
    }
    .panel-item:hover { color: var(--text-light); background-color: rgba(255,255,255,0.1); }
    .selected { background: var(--primary-gradient) !important; font-weight: bold; }
    
    .list-ch { min-width: 50px; font-weight: bold; }
    #channel_list .nav_logo { width: 50px; margin: auto 0 auto auto; text-align: center; display: flex; justify-content: center; align-items: center; height: 35px; }
    #channel_list .nav_logo img { max-height: 100%; max-width: 100%; object-fit: contain; }
    #channel_list .list-title { overflow: hidden; text-overflow: ellipsis; }
    .fav-star { margin-right: 10px; font-size: 16px; }

    #search_item_wrapper { padding: 8px 20px; }
    #search_field { width: 100% !important; background: rgba(255,255,255,0.9); display: block; font-size: 18px; padding: 8px; border-radius: 4px; border: 2px solid #333; color: #000; }
    #search_field:focus { border-color: var(--primary-color); background-color: var(--text-light); }

    #channel_info {
      z-index: 30; position: fixed; right: 0; top: 50%; transform: translate(110%, -50%);
      transition: opacity 0.3s, transform 0.4s; width: 80%; max-width: 450px;
      opacity: 0; color: var(--text-light); border-radius: 16px 0 0 16px; box-shadow: 0 10px 30px 0 rgba(0, 0, 0, 0.5); text-shadow: 2px 2px 3px #000; background-image: linear-gradient(to right, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.8)); padding: 15px; display: flex; align-items: center;
    }
    #channel_info.visible { transform: translate(0, -50%); opacity: 1; }
    #ch_logo { flex-shrink: 0; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
    #ch_logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #channel_name { font-size: clamp(22px, 3.5vw, 32px); font-weight: bold; line-height: 1.2; margin-bottom: 8px; }
    #channel_epg { font-size: clamp(16px, 2.5vw, 22px); color: var(--text-medium); }

    .custom-scrollbar::-webkit-scrollbar { width: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; border: 2px solid darkblue; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #333; }
    #brand-header { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
    #brand-header svg { width: 35px; height: 35px; margin-right: 15px; }
    #brand-header span { font-size: clamp(22px, 3vw, 28px); font-weight: bold; color: var(--text-light); }

    #idle_animation {
      z-index: 2; display: flex; justify-content: flex-end; align-items: center;
      background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://static0.gamerantimages.com/wordpress/wp-content/uploads/2025/04/sung-jinwoo-solo-leveling.jpg?w=1600&h=900&fit=crop');
      background-size: cover; background-position: center;
    }
    .idle-branding { position: relative; padding-right: 40px; text-align: right; color: white; text-shadow: 3px 3px 8px rgba(0,0,0,0.9); }
    .idle-branding h1 { font-size: 5vw; margin: 0; font-weight: bold; animation: pulseText 3s infinite ease-in-out; }
    .idle-branding p { font-size: 2vw; margin: 0; color: #00ff7f; font-weight: bold; }
    @keyframes pulseText { 0%, 100% { transform: scale(0.98); opacity: 0.9; } 50% { transform: scale(1); opacity: 1; } }

    #play_button_overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 120px; height: 120px; background: rgba(0, 0, 0, 0.5); border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; transition: background 0.3s ease; z-index: 3; }
    #play_button_overlay:hover { background: rgba(65, 105, 225, 0.8); }
    #play_button_overlay svg { width: 60px; height: 60px; fill: white; margin-left: 10px; }
  </style>
</head>
<body>
  <div id="jwplayer_container"><div id="jwplayer"></div></div>
  <div id="shaka_player_container" class="HIDDEN"><video id="shaka_player" autoplay muted playsinline></video></div>
  
  <div id="blur_overlay" class="fullscreen"></div>
  <div id="ui_elements">
    <div id="channel_loader_overlay" class="fullscreen HIDDEN">
      <div class="loader-content"><span class="loading-text">Loading Channel...</span><div class="loader-bar"></div></div>
    </div>
    <div id="idle_animation" class="fullscreen">
      <div class="idle-branding"><h1>SHAKZZ TV</h1><p>FOR FREE</p></div>
      <div id="play_button_overlay"><svg viewbox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg></div>
    </div>
    <div id="nav">
      <div id="brand-header">
        <svg viewbox="0 0 24 24" fill="white"><path d="M21,3H3C1.89,3,1,3.89,1,5V17C1,18.11,1.89,19,3,19H8V21H16V19H21C22.11,19,23,18.11,23,17V5C23,3.89,22.11,3,21,3M21,17H3V5H21V17M16,11L11,15V7L16,11Z"></path></svg>
        <span>Shakzz TV</span>
      </div>
      <div id="search_item_wrapper"><input id="search_field" type="search" placeholder="Search"></div>
      <div id="list_container_scrollarea" style="height: calc(100vh - 120px);">
        <div id="list_container">
          <div id="group_list" class="custom-scrollbar">
            <h2 class="list_headline">CATEGORIES</h2>
            <ul id="dynamic_groups_list">
              <li class="panel-item" data-group="__fav">FAVORITES</li>
              <li class="panel-item" data-group="__all">ALL CHANNELS</li>
            </ul>
          </div>
          <div id="channel_list" class="custom-scrollbar"></div>
        </div>
      </div>
    </div>
    <div id="channel_settings">
        <h2 class="list_headline">Settings</h2>
        <ul id="channel_settings_list"></ul>
    </div>
    <div id="channel_info">
      <div id="ch_logo"></div>
      <div id="channel_text_container">
        <div id="channel_name"></div>
        <div id="channel_epg"></div>
      </div>
    </div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    /*******************************
     * Channels + Config
     *******************************/
    const channels = {
        KidoodleTV: { name: "Kidoodle TV", type: "hls", manifestUri: "https://amg07653-apmc-amg07653c5-samsung-ph-8539.playouts.now.amagi.tv/playlist.m3u8", logo: "https://d1iiooxwdowqwr.cloudfront.net/pub/appsubmissions/20201230211817_FullLogoColor4x.png", group: ["cartoons & animations"] },
        StrawberryShortcake: { name: "Strawberry Shortcake", type: "hls", manifestUri: "https://upload.wikimedia.org/wikipedia/en/f/ff/Strawberry_Shortcake_2003_Logo.png", logo: "https://upload.wikimedia.org/wikipedia/en/f/ff/Strawberry_Shortcake_2003_Logo.png", group: ["cartoons & animations"] },
        SonictheHedgehog: { name: "Sonic the Hedgehog", type: "hls", manifestUri: "https://d1si3n1st4nkgb.cloudfront.net/10000/88258004/hls/master.m3u8?ads.xumo_channelId=88258004", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Sonic_The_Hedgehog.svg/1200px-Sonic_The_Hedgehog.svg.png", group: ["cartoons & animations"] },
        SuperMario: { name: "Super Mario", type: "hls", manifestUri: "https://d1si3n1st4nkgb.cloudfront.net/10000/88258005/hls/master.m3u8?ads.xumo_channelId=88258005", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRFkMkkUmZBGslGWGZMN2er5emlnqGCCU49wg&s", group: ["cartoons & animations"] },
        Teletubbies: { name: "Teletubbies", type: "hls", manifestUri: "https://d1si3n1st4nkgb.cloudfront.net/10000/88258003/hls/master.m3u8?ads.xumo_channelId=88258003", logo: "https://upload.wikimedia.org/wikipedia/en/thumb/5/5a/Teletubbies_Logo.png/330px-Teletubbies_Logo.png", group: ["cartoons & animations"] },
        anione: { name: "Ani One", type: "hls", manifestUri: "https://amg19223-amg19223c9-amgplt0019.playout.now3.amagi.tv/playlist/amg19223-amg19223c9-amgplt0019/playlist.m3u8", logo: "https://www.medialink.com.hk/img/ani-one-logo.jpg", group: ["cartoons & animations"] },
        gma7: { name: "GMA 7", type: "clearkey", manifestUri: "https://vod.nathcreqtives.com/1093/manifest.mpd", keyId: "31363231383438333031323033393138", key: "38694e34324d543478316b7455753437", logo: "https://i.imgur.com/Cu1tAY8.png", group: ["news", "entertainment"] },
        jeepneytv: { name: "Jeepney TV", type: "clearkey", manifestUri: "https://abslive.akamaized.net/dash/live/2028025/jeepneytv/manifest.mpd", keyId: "90ea4079e02f418db7b170e8763e65f0", key: "1bfe2d166e31d03eee86ee568bd6c272", logo: "https://upload.wikimedia.org/wikipedia/en/1/15/Jeepney_TV_Logo_2015.svg", group: ["entertainment"] },
        aniplus: { name: "Aniplus", type: "hls", manifestUri: "https://amg18481-amg18481c1-amgplt0352.playout.now3.amagi.tv/playlist/amg18481-amg18481c1-amgplt0352/playlist.m3u8", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSJj494OpI0bKrTrvcHqEkzMYzqtfLNdWjQrg&s", group: ["cartoons & animations"] },
        sinemanila: { name: "SineManila", type: "hls", manifestUri: "https://live20.bozztv.com/giatv/giatv-sinemanila/sinemanila/chunks.m3u8", logo: "https://is5-ssl.mzstatic.com/image/thumb/Purple112/v4/64/72/72/64727284-ad63-33a7-59a6-7975c742c038/AppIcon-0-0-1x_U007emarketing-0-0-0-5-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/512x512bb.jpg", group: ["movies", "entertainment"] },
        pbarush: { name: "PBA Rush", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/cg_pbarush_hd1/default/index.mpd", keyId: "76dc29dd87a244aeab9e8b7c5da1e5f3", key: "95b2f2ffd4e14073620506213b62ac82", logo: "https://static.wikia.nocookie.net/logopedia/images/0/00/PBA_Rush_Logo_2016.png", group: ["entertainment"] },
        animalplanet: { name: "Animal Planet", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/cg_animal_planet_sd/default/index.mpd", keyId: "436b69f987924fcbbc06d40a69c2799a", key: "c63d5b0d7e52335b61aeba4f6537d54d", logo: "https://i.imgur.com/SkpFpW4.png", group: ["documentary"] },
        discoverychannel: { name: "Discovery Channel", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/discovery/default/index.mpd", keyId: "d9ac48f5131641a789328257e778ad3a", key: "b6e67c37239901980c6e37e0607ceee6", logo: "https://i.imgur.com/XsvAk5H.png", group: ["documentary"] },
        nickelodeon: { name: "Nickelodeon", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/dr_nickelodeon/default/index.mpd", keyId: "9ce58f37576b416381b6514a809bfd8b", key: "f0fbb758cdeeaddfa3eae538856b4d72", logo: "https://i.imgur.com/4o5dNZA.png", group: ["cartoons & animations"] },
        nickjr: { name: "Nick Jr", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/dr_nickjr/default/index.mpd", keyId: "bab5c11178b646749fbae87962bf5113", key: "0ac679aad3b9d619ac39ad634ec76bc8", logo: "https://i.imgur.com/iIVYdZP.png", group: ["cartoons & animations"] },
        pbo: { name: "PBO", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/pbo_sd/default/index.mpd", keyId: "dcbdaaa6662d4188bdf97f9f0ca5e830", key: "31e752b441bd2972f2b98a4b1bc1c7a1", logo: "https://i.imgur.com/550RYpJ.png", group: ["movies", "entertainment"] },
        angrybirds: { name: "Angry Birds", type: "hls", manifestUri: "https://stream-us-east-1.getpublica.com/playlist.m3u8?network_id=547", logo: "https://www.pikpng.com/pngl/m/83-834869_angry-birds-theme-angry-birds-game-logo-png.png", group: ["cartoons & animations"] },
        zoomooasia: { name: "Zoo Moo Asia", type: "hls", manifestUri: "https://zoomoo-samsungau.amagi.tv/playlist.m3u8", logo: "https://ia803207.us.archive.org/32/items/zoo-moo-kids-2020_202006/ZooMoo-Kids-2020.png", group: ["cartoons & animations", "entertainment"] },
        // This channel is marked to use the Shaka Player fallback
        iQIYI: { player: 'shaka', name: "iQIYI", type: "clearkey", manifestUri: "https://linearjitp-playback.astro.com.my/dash-wv/linear/1006/default_ott.mpd", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSs3X1_D_GkWQbMiZzbmaoFets_gAeM6zKGhvtuAD7y46OH9zcqWCnLoG3K&s=10", group: ["entertainment"], userAgent: "Mozilla/5.0 (Linux; Android 14; 27821-67832-42-315-4231-233-21-43-12-1312-321-23-21-232-) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/133.0.0.0 Mobile Safari/537.36", keyId: "7ef7e913ce85a1131b27036069169a10", key: "77d98ed71db7524c27875a09a975f9e6" },
        tv5: { name: "TV 5 HD", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/tv5_hd/default1/index.mpd", keyId: "2615129ef2c846a9bbd43a641c7303ef", key: "07c7f996b1734ea288641a68e1cfdc4d", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/TV5_logo.svg/1200px-TV5_logo.svg.png", group: ["news", "entertainment"] },
        kapamilya: { name: "Kapamilya Channel HD", type: "clearkey", manifestUri: "https://d1uf7s78uqso1e.cloudfront.net/out/v1/efa01372657648be830e7c23ff68bea2/index.mpd", keyId: "bd17afb5dc9648a39be79ee3634dd4b8", key: "3ecf305d54a7729299b93a3d69c02ea5", logo: "https://cms.cignal.tv/Upload/Images/Kapamilya Channel Logo alpha.png", group: ["news", "entertainment"] },
    };
    
    // --- State Variables ---
    let jwplayerInstance, shakaPlayer, iCurrentChannel = 0, iGroupListIndex = 1, iChannelSettingsIndex = 0;
    let aFilteredChannelKeys = [], sSelectedGroup = '__all';
    let bNavOpened = false, bGroupsOpened = false, bChannelSettingsOpened = false;
    let channelNameTimeout, isSessionActive = false;
    let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;

    // --- DOM Element Cache ---
    const getEl = id => document.getElementById(id);
    const o = {
        JWPlayerContainer: getEl("jwplayer_container"),
        ShakaPlayerContainer: getEl("shaka_player_container"), ShakaPlayer: getEl("shaka_player"),
        Nav: getEl("nav"), BlurOverlay: getEl("blur_overlay"),
        ChannelSettings: getEl("channel_settings"), ChannelSettingsList: getEl("channel_settings_list"),
        ChannelList: getEl("channel_list"), ChannelInfo: getEl("channel_info"),
        SearchField: getEl("search_field"), IdleAnimation: getEl("idle_animation"),
        PlayButton: getEl("play_button_overlay"), ChannelLoader: getEl("channel_loader_overlay"),
        GroupList: getEl("group_list"), ListContainer: getEl("list_container"), DynamicGroupsList: getEl('dynamic_groups_list')
    };

    // --- Core Player Functions ---
    async function initPlayers() {
        Object.keys(channels).forEach((key, i) => { channels[key].number = i + 1; channels[key].key = key; });
        loadFavoritesFromStorage();
        buildDynamicGroupNav();
        sSelectedGroup = '__all';
        buildNav();
        updateSelectedGroupInNav();
        
        // Init JW Player
        jwplayerInstance = jwplayer("jwplayer").setup({
            width: "100%", height: "100%", autostart: false, mute: true,
            aspectratio: "16:9", stretching: "exactfit", controls: false
        });
        jwplayerInstance.on('error', () => showIdleAnimation(true));
        
        // Init Shaka Player
        await shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            shakaPlayer = new shaka.Player(o.ShakaPlayer);
            shakaPlayer.configure({ abr: { defaultBandwidthEstimate: 500000 }, streaming: { rebufferingGoal: 2, bufferingGoal: 8 } });
            shakaPlayer.addEventListener('error', e => { console.error('Shaka Error:', e.detail); showIdleAnimation(true); });
        }
        
        loadInitialChannel();
    }

    function loadInitialChannel() {
        const storedLast = localStorage.getItem('iptvLastWatched');
        let initialChannelKey = 'aniplus';
        if (storedLast && channels[storedLast]) initialChannelKey = storedLast;
        const initialIndex = aFilteredChannelKeys.indexOf(initialChannelKey);
        loadChannel(initialIndex >= 0 ? initialIndex : 0, { isInitialLoad: true });
    }

    function loadChannel(index, options = {}) {
        if (!aFilteredChannelKeys.length) { jwplayerInstance.stop(); shakaPlayer?.unload(); showIdleAnimation(true); return; }
        iCurrentChannel = (index < 0) ? aFilteredChannelKeys.length - 1 : index % aFilteredChannelKeys.length;
        const channelKey = aFilteredChannelKeys[iCurrentChannel];
        const channel = channels[channelKey];

        localStorage.setItem('iptvLastWatched', channelKey);
        if (!options.isInitialLoad) {
            o.ChannelLoader.classList.remove('HIDDEN');
            o.BlurOverlay.classList.add('visible');
        }
        showChannelName();
        updateSelectedChannelInNav();

        // ** The Smart Player Switch **
        if (channel.player === 'shaka') {
            loadWithShakaPlayer(channel);
        } else {
            loadWithJWPlayer(channel);
        }

        setTimeout(() => {
            o.ChannelLoader.classList.add('HIDDEN');
            o.BlurOverlay.classList.remove('visible');
        }, 1500);
    }

    function loadWithJWPlayer(channel) {
        shakaPlayer?.unload(); // Stop shaka if it was playing
        o.ShakaPlayerContainer.classList.add('HIDDEN');
        o.JWPlayerContainer.classList.remove('HIDDEN');
        
        const playlistItem = { file: channel.manifestUri, title: channel.name };
        if (channel.type === 'clearkey' && channel.keyId && channel.key) {
            playlistItem.drm = { clearkey: { keyId: channel.keyId, key: channel.key } };
        }
        jwplayerInstance.load([playlistItem]);

        if (isSessionActive) {
            jwplayerInstance.play();
            jwplayerInstance.setMute(false);
            hideIdleAnimation();
        }
    }

    async function loadWithShakaPlayer(channel) {
        jwplayerInstance.stop(); // Stop JW if it was playing
        o.JWPlayerContainer.classList.add('HIDDEN');
        o.ShakaPlayerContainer.classList.remove('HIDDEN');

        if (!shakaPlayer) return;

        try {
            shakaPlayer.configure('drm.clearKeys', {});
            if (channel.type === 'clearkey' && channel.keyId && channel.key) {
                shakaPlayer.configure({ drm: { clearKeys: { [channel.keyId]: channel.key } } });
            }
            shakaPlayer.getNetworkingEngine()?.clearAllRequestFilters();
            if (channel.userAgent) {
                shakaPlayer.getNetworkingEngine()?.registerRequestFilter((type, request) => { request.headers['User-Agent'] = channel.userAgent; });
            }
            await shakaPlayer.load(channel.manifestUri);
            if (isSessionActive) {
                o.ShakaPlayer.muted = false;
                o.ShakaPlayer.play();
                hideIdleAnimation();
            }
        } catch (error) {
            console.error(`Shaka error loading: ${channel?.name}`, error);
            showIdleAnimation(true);
        }
    }

    // --- UI and Navigation ---
    function buildDynamicGroupNav() {
        const allGroups = new Set(Object.values(channels).flatMap(ch => ch.group || []));
        const sortedGroups = [...allGroups].sort();
        let groupHtml = '';
        sortedGroups.forEach(name => { groupHtml += `<li class="panel-item" data-group="${name}">${name.toUpperCase()}</li>`; });
        o.DynamicGroupsList.insertAdjacentHTML('beforeend', groupHtml);
        o.GroupList.querySelectorAll('li[data-group]').forEach((li, index) => {
            li.onclick = () => selectGroup(index);
        });
    }

    function selectGroup(index) {
        const item = o.GroupList.querySelectorAll('li[data-group]')[index];
        if (!item || !item.dataset.group) return;
        iGroupListIndex = index;
        updateSelectedGroupInNav();
        sSelectedGroup = item.dataset.group;
        hideGroups();
        setTimeout(() => {
            buildNav();
            if (aFilteredChannelKeys.length === 0) { jwplayerInstance.stop(); shakaPlayer?.unload(); showIdleAnimation(true); }
        }, 300);
    }
    
    function buildNav() {
        const searchTerm = o.SearchField.value.toLowerCase();
        aFilteredChannelKeys = Object.keys(channels).filter(key => {
            const ch = channels[key];
            const inGroup = sSelectedGroup === '__all' || (sSelectedGroup === '__fav' && ch.favorite) || (ch.group && ch.group.includes(sSelectedGroup));
            const inSearch = !searchTerm || ch.name.toLowerCase().includes(searchTerm);
            return inGroup && inSearch;
        }).sort((a, b) => channels[a].number - channels[b].number);
        o.ChannelList.innerHTML = '';
        if (aFilteredChannelKeys.length === 0) { o.ChannelList.innerHTML = `<li class="panel-item" style="justify-content:center; color:#888;">No channels found.</li>`; return; }
        const frag = document.createDocumentFragment();
        aFilteredChannelKeys.forEach((key, index) => {
            const ch = channels[key];
            const item = document.createElement('li');
            item.className = 'panel-item';
            item.onclick = () => { loadChannel(index); setTimeout(hideNav, 100); };
            const fav = ch.favorite ? `<span class="fav-star">⭐</span>` : '';
            const logo = ch.logo ? `<div class="nav_logo"><img src="${ch.logo}" alt=""></div>` : '';
            item.innerHTML = `${fav}<span class="list-ch">${ch.number}</span><span class="list-title">${ch.name}</span>${logo}`;
            frag.appendChild(item);
        });
        o.ChannelList.appendChild(frag);
        updateSelectedChannelInNav();
    }
    
    function updateSelectedChannelInNav() {
        o.ChannelList.querySelector('.selected')?.classList.remove('selected');
        const newItem = o.ChannelList.querySelectorAll('li.panel-item')[iCurrentChannel];
        if (newItem) { newItem.classList.add('selected'); if (bNavOpened) newItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }
    
    function updateSelectedGroupInNav() {
        o.GroupList.querySelector('.selected')?.classList.remove('selected');
        const newItem = o.GroupList.querySelectorAll('li[data-group]')[iGroupListIndex];
        if (newItem) { newItem.classList.add('selected'); if(bGroupsOpened) newItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }

    function renderChannelSettings() {
        const currentChannel = channels[aFilteredChannelKeys[iCurrentChannel]];
        if (!currentChannel) return;
        o.ChannelSettingsList.innerHTML = `<li class="panel-item" onclick="toggleFavourite()">${currentChannel.favorite ? 'Remove from Favorites' : 'Add to Favorites'}</li>`;
    }

    function toggleFavourite() {
        const key = aFilteredChannelKeys[iCurrentChannel]; if (!key) return;
        channels[key].favorite = !channels[key].favorite;
        saveFavoritesToStorage(); 
        renderChannelSettings();
        buildNav();
    }
    
    function showIdleAnimation(showPlayButton = false) { o.IdleAnimation.classList.remove('HIDDEN'); if (showPlayButton && !isSessionActive) { o.PlayButton.classList.remove('HIDDEN'); } else { o.PlayButton.classList.add('HIDDEN'); } }
    function hideIdleAnimation() { o.IdleAnimation.classList.add('HIDDEN'); isSessionActive = true; }
    function clearUi(exclude) { if (exclude !== 'nav') hideNav(); if (exclude !== 'channelSettings') hideChannelSettings(); if (exclude !== 'channelName') hideChannelName(); }
    function showNav() { clearUi('nav'); bNavOpened = true; o.Nav.classList.add('visible'); }
    function hideNav() { bNavOpened = bGroupsOpened = false; o.Nav.classList.remove('visible'); }
    function showGroups() { if(bNavOpened) { bGroupsOpened = true; o.ListContainer.classList.add('groups-opened'); updateSelectedGroupInNav(); } }
    function hideGroups() { bGroupsOpened = false; o.ListContainer.classList.remove('groups-opened'); }
    function showChannelSettings() { clearUi('channelSettings'); renderChannelSettings(); bChannelSettingsOpened = true; o.ChannelSettings.classList.add('visible'); }
    function hideChannelSettings() { bChannelSettingsOpened = false; o.ChannelSettings.classList.remove('visible'); }

    function showChannelName() { clearTimeout(channelNameTimeout); if (!aFilteredChannelKeys.length) return; const ch = channels[aFilteredChannelKeys[iCurrentChannel]]; if (!ch) return; getEl('channel_name').textContent = ch.name; getEl('channel_epg').textContent = 'EPG not available'; getEl('ch_logo').innerHTML = ch.logo ? `<img src="${ch.logo}" alt="${ch.name} logo">` : ''; o.ChannelInfo.classList.add('visible'); channelNameTimeout = setTimeout(hideChannelName, 5000); }
    function hideChannelName() { o.ChannelInfo.classList.remove('visible'); }
    function loadFavoritesFromStorage() { try { const favs = JSON.parse(localStorage.getItem("iptvFavoriteChannels") || "[]"); Object.keys(channels).forEach(key => channels[key].favorite = favs.includes(key)); } catch(e) {} }
    function saveFavoritesToStorage() { try { const favs = Object.entries(channels).filter(([,ch]) => ch.favorite).map(([key]) => key); localStorage.setItem("iptvFavoriteChannels", JSON.stringify(favs)); } catch(e) {} }
    function handleFirstPlay() { 
        isSessionActive = true; 
        hideIdleAnimation(); 
        const currentChannel = channels[aFilteredChannelKeys[iCurrentChannel]];
        if (currentChannel.player === 'shaka') {
            o.ShakaPlayer.play();
            o.ShakaPlayer.muted = false;
        } else {
            jwplayerInstance.play();
            jwplayerInstance.setMute(false);
        }
        o.PlayButton.classList.add('HIDDEN'); 
    }

    // --- Event Listeners ---
    o.PlayButton.addEventListener('click', handleFirstPlay);
    o.SearchField.addEventListener('input', () => { buildNav(); if (aFilteredChannelKeys.length > 0) { if(isSessionActive) loadChannel(0); } else { jwplayerInstance.stop(); shakaPlayer?.unload(); showIdleAnimation(true); } });
    
    document.addEventListener('keydown', (e) => {
        if (document.activeElement === o.SearchField) return;
        
        if (bNavOpened) {
            e.preventDefault();
            if (bGroupsOpened) {
                const groupItems = o.GroupList.querySelectorAll('li[data-group]');
                if (e.key === 'ArrowUp') iGroupListIndex = Math.max(0, iGroupListIndex - 1);
                else if (e.key === 'ArrowDown') iGroupListIndex = Math.min(groupItems.length - 1, iGroupListIndex + 1);
                else if (e.key === 'Enter') groupItems[iGroupListIndex]?.click();
                else if (e.key === 'ArrowRight' || e.key === 'Escape') hideGroups();
                updateSelectedGroupInNav();
            } else {
                if (e.key === 'ArrowUp') iCurrentChannel = (iCurrentChannel - 1 + aFilteredChannelKeys.length) % aFilteredChannelKeys.length;
                else if (e.key === 'ArrowDown') iCurrentChannel = (iCurrentChannel + 1) % aFilteredChannelKeys.length;
                else if (e.key === 'Enter') { loadChannel(iCurrentChannel); hideNav(); }
                else if (e.key === 'ArrowRight' || e.key === 'Escape') hideNav();
                else if (e.key === 'ArrowLeft') showGroups();
                updateSelectedChannelInNav();
            }
        } else if (bChannelSettingsOpened) {
            e.preventDefault();
            const items = o.ChannelSettingsList.querySelectorAll('.panel-item');
            if (e.key === 'Enter') items[iChannelSettingsIndex]?.click();
            else if (e.key === 'ArrowLeft' || e.key === 'Escape') hideChannelSettings();
        } else {
            switch (e.key) {
                case 'ArrowLeft': e.preventDefault(); showNav(); break;
                case 'ArrowRight': e.preventDefault(); showChannelSettings(); break;
                case 'Enter': e.preventDefault(); showChannelName(); break;
                case 'ArrowUp': e.preventDefault(); loadChannel(iCurrentChannel - 1); break;
                case 'ArrowDown': e.preventDefault(); loadChannel(iCurrentChannel + 1); break;
                case 'Escape': e.preventDefault(); clearUi(); break;
            }
        }
    });

    document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; });
    document.addEventListener('touchmove', e => { touchEndX = e.touches[0].clientX; touchEndY = e.touches[0].clientY; });
    document.addEventListener('touchend', () => {
        const deltaX = touchEndX - touchStartX; const deltaY = touchEndY - touchStartY;
        const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
        if (isHorizontal && Math.abs(deltaX) > 50) {
            if (deltaX > 0) { if (bChannelSettingsOpened) hideChannelSettings(); else showNav(); } 
            else { if (bNavOpened) hideNav(); else showChannelSettings(); }
        } else if (!isHorizontal && Math.abs(deltaY) > 50) {
            if (!bNavOpened && !bChannelSettingsOpened) { if (deltaY > 0) loadChannel(iCurrentChannel + 1); else loadChannel(iCurrentChannel - 1); }
        } else if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
            if (!bNavOpened && !bChannelSettingsOpened) showChannelName();
        }
    });
    initPlayers();
});
</script>
</body>
</html>

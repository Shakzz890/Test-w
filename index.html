<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Shakzz TV Player - Refactored</title>
  <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.13/dist/shaka-player.ui.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/shaka-player@4.7.13/dist/controls.css">
  <style>
    :root {
      --primary-color: royalblue;
      --primary-gradient: linear-gradient(to right, rgba(65, 105, 225, 0.75), rgba(0, 0, 0, 0));
      --panel-bg-left: linear-gradient(to right, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4));
      --panel-bg-right: linear-gradient(to left, rgba(0, 0, 0, 0.9), rgba(0, 0, 0, 0.4));
      --text-light: #fff;
      --text-medium: #ccc;
      --text-dark: #000;
      --border-color: #444;
      --settings-item-bg: rgba(255, 255, 255, 0.1);
      --settings-item-hover-bg: rgba(255, 255, 255, 0.2);
      --nav-width: clamp(320px, 25vw, 400px); /* NEW: Define nav width as variable */
    }
    * { font-family: Lucida Sans, Arial, Helvetica, sans-serif; outline: none; box-sizing: border-box; }
    html, body {
      overscroll-behavior: none; margin: 0; padding: 0; background-color: #000;
      font-size: 28px; -moz-user-select: none; -webkit-user-select: none;
      user-select: none; touch-action: none; overflow: hidden; height: 100%;
    }
    #player_container { z-index: 1; position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; border: 0; background: transparent; cursor: none; transition: transform 0.3s ease, object-fit 0.3s ease; }
    .fullscreen { width: 100%; height: 100%; position: fixed; top: 0; left: 0; }
    .HIDDEN { display: none !important; }

    #blur_overlay { z-index: 25; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
    #blur_overlay.visible { opacity: 1; }

    #channel_loader_overlay { z-index: 60; display: flex; justify-content: center; align-items: center; pointer-events: none; }
    .loader-content { text-align: center; color: var(--text-light); pointer-events: auto; }
    .loading-text { font-size: clamp(24px, 4vw, 32px); font-weight: bold; text-shadow: 2px 2px 5px #000; display: block; margin-bottom: 20px; }
    .loader-bar { width: 250px; height: 4px; background-color: rgba(255, 255, 255, 0.3); border-radius: 2px; position: relative; overflow: hidden; margin: 0 auto; }
    .loader-bar::after { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 50%; background: var(--primary-color); border-radius: 2px; animation: loading-bar-animation 1.5s linear infinite; }
    @keyframes loading-bar-animation { 0% { left: -50%; } 100% { left: 100%; } }

    .close-button { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ffffff'%3E%3Cpath d='M13.41,12l6.3-6.29a1,1,0,1,0-1.42-1.42L12,10.59,5.71,4.29A1,1,0,0,0,4.29,5.71L10.59,12l-6.3,6.29a1,1,0,0,0,0,1.42,1,1,0,0,0,1.42,0L12,13.41l6.29,6.3a1,1,0,0,0,1.42,0,1,1,0,0,0,0-1.42Z'/%3E%3C/svg%3E"); background-size: cover; cursor: pointer; position: absolute; z-index: 11; top: 10px; right: 10px; height: 40px; width: 40px; }

    #nav { 
      z-index: 31; 
      position: fixed; 
      top: 0; 
      width: var(--nav-width); /* UPDATED: Use variable */
      max-width: 90%; 
      overflow: hidden; 
      height: 100%; 
      transition: transform 0.5s; 
      font-size: clamp(18px, 2.5vw, 22px); 
      left: 0; 
      transform: translateX(-100%); 
      background-image: var(--panel-bg-left); 
    }
    #nav.visible { transform: translateX(0); }
    #list_container { display: flex; width: 200%; height: 100%; color: var(--text-light); transition: transform 0.5s; transform: translateX(-50%); }
    #list_container.groups-opened { transform: translateX(0); }
    #group_list, #channel_list { height: 100%; width: 50%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
    h2.list_headline { margin: 20px 30px; font-size: clamp(24px, 3vw, 28px); color: var(--text-medium); }
    ul { list-style: none; margin: 0; padding: 0; }
    li { padding: 4px 20px; margin: 2px 0; white-space: nowrap; cursor: pointer; height: 50px; line-height: 50px; display: flex; align-items: center; }
    li:hover { color: var(--text-light); }
    .selected { background: var(--primary-gradient) !important; font-weight: bold; }
    .list-ch { min-width: 50px; font-weight: bold; }
    #channel_list .nav_logo { width: 50px; margin: auto 0 auto auto; text-align: center; display: flex; justify-content: center; align-items: center; height: 35px; }
    #channel_list .nav_logo img { max-height: 100%; max-width: 100%; object-fit: contain; }
    #channel_list .list-title { overflow: hidden; text-overflow: ellipsis; }
    .fav-star { margin-right: 10px; font-size: 16px; }

    #search_item_wrapper { padding: 8px 20px; }
    #search_field { width: 100% !important; background: rgba(255,255,255,0.9); display: block; font-size: 18px; padding: 8px; border-radius: 4px; border: 2px solid #333; color: #000; }
    #search_field:focus { border-color: var(--primary-color); background-color: var(--text-light); }

    #channel_info {
      z-index: 30; position: fixed; right: 0; top: 50%; transform: translate(110%, -50%);
      transition: opacity 0.3s, transform 0.4s; width: 80%; max-width: 450px;
      opacity: 0; color: var(--text-light); border-radius: 16px 0 0 16px; box-shadow: 0 10px 30px 0 rgba(0, 0, 0, 0.5); text-shadow: 2px 2px 3px #000; background-image: linear-gradient(to right, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.8)); padding: 15px; display: flex; align-items: center;
    }
    #channel_info.visible { transform: translate(0, -50%); opacity: 1; }
    #ch_logo { flex-shrink: 0; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
    #ch_logo img { max-width: 100%; max-height: 100%; object-fit: contain; }
    #channel_name { font-size: clamp(22px, 3.5vw, 32px); font-weight: bold; line-height: 1.2; margin-bottom: 8px; }
    #channel_epg { font-size: clamp(16px, 2.5vw, 22px); color: var(--text-medium); }

    .custom-scrollbar::-webkit-scrollbar { width: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--primary-color); border-radius: 20px; border: 2px solid darkblue; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #333; }
    #brand-header { display: flex; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
    #brand-header svg { width: 35px; height: 35px; margin-right: 15px; }
    #brand-header span { font-size: clamp(22px, 3vw, 28px); font-weight: bold; color: var(--text-light); }
    
    .fullscreen-popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background-image: var(--panel-bg-right); color: var(--text-light); border-radius: 8px; box-shadow: 0 10px 30px 0 rgba(0, 0, 0, 0.5); text-shadow: 1px 1px 2px #000; }
    
    /* FIX: Make sure fullscreen modals are on top of the blur overlay */
    #guide, #settings_modal {
      z-index: 40;
    }

    .fullscreen-popup h2 { margin: 0; font-size: clamp(22px, 4vw, 28px); padding: 20px 25px; color: var(--text-light); }
    .popup-content-list { padding: 0 0 10px 0; }
    .popup-content-list li { padding: 15px 25px; height: auto; white-space: normal; line-height: 1.4; font-size: clamp(18px, 2.5vw, 22px); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .popup-content-list li:last-child { border-bottom: none; }
    .popup-buttons { display: flex; justify-content: flex-end; padding: 15px 25px; background: rgba(0,0,0,0.2); }
    .popup-buttons button { background: none; border: none; color: var(--primary-color); font-weight: bold; font-size: 18px; padding: 8px 15px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; }
    .popup-buttons button:hover { background-color: rgba(255,255,255,0.1); }
    input[type="radio"] { appearance: none; -webkit-appearance: none; width: 22px; height: 22px; border: 2px solid var(--text-medium); border-radius: 50%; outline: none; cursor: pointer; transition: border-color 0.2s; margin-left: 15px; }
    input[type="radio"]:checked { border-color: var(--primary-color); background-color: var(--primary-color); box-shadow: inset 0 0 0 3px #000; }
    .edit-modal-field { width:100%; background: #333; border: 1px solid #555; color: #fff; padding: 10px; margin-bottom: 15px; font-size: 18px; }
    
    #idle_animation {
      /* FIX: Increased z-index from 2 to 28.
        This places the idle screen ON TOP of the blur overlay (z-index: 25)
        but BELOW the channel info/nav/settings panels (z-index: 30+),
        allowing the play button to be clicked.
      */
      z-index: 28; 
      display: flex; justify-content: flex-end; align-items: center;
      background-image: linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.6)), url('https://static0.gamerantimages.com/wordpress/wp-content/uploads/2025/04/sung-jinwoo-solo-leveling.jpg?w=1600&h=900&fit=crop');
      background-size: cover; background-position: center;
      /* NEW: Make the overlay non-interactive by default */
      pointer-events: none;
    }
    .idle-branding { position: relative; padding-right: 40px; text-align: right; color: white; text-shadow: 3px 3px 8px rgba(0,0,0,0.9); }
    .idle-branding h1 { font-size: 5vw; margin: 0; font-weight: bold; animation: pulseText 3s infinite ease-in-out; }
    .idle-branding p { font-size: 2vw; margin: 0; color: #00ff7f; font-weight: bold; }
    @keyframes pulseText { 0%, 100% { transform: scale(0.98); opacity: 0.9; } 50% { transform: scale(1); opacity: 1; } }

    #play_button_overlay { 
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
      width: 120px; height: 120px; background: rgba(0, 0, 0, 0.5); 
      border-radius: 50%; display: flex; justify-content: center; 
      align-items: center; cursor: pointer; transition: background 0.3s ease; 
      /* FIX: Removed z-index: 3, added pointer-events: auto to make it clickable */
      pointer-events: auto; 
    }
    #play_button_overlay:hover { background: rgba(65, 105, 225, 0.8); }
    #play_button_overlay svg { width: 60px; height: 60px; fill: white; margin-left: 10px; }

    /* New Settings Panel Styles */
    #channel_settings { right: 0; transform: translateX(100%); background-image: var(--panel-bg-right); z-index: 31; position: fixed; top: 0; width: clamp(320px, 25vw, 400px); max-width: 90%; overflow: hidden; height: 100%; transition: transform 0.5s; font-size: clamp(18px, 2.5vw, 22px); color: var(--text-light); }
    #channel_settings.visible { transform: translateX(0); }
    #settings_container { position: relative; width: 200%; height: 100%; display: flex; transition: transform 0.4s ease-in-out; }
    #settings_container.submenu-visible { transform: translateX(-50%); }
    #settings_main_menu, #settings_video_format_menu { width: 50%; height: 100%; padding: 20px 0; }
    .settings-item { padding: 15px 25px; cursor: pointer; transition: background-color 0.2s; }
    .settings-item.selected { background-color: var(--settings-item-hover-bg); }
    .settings-item-header { font-size: clamp(24px, 3vw, 28px); color: var(--text-medium); margin: 20px 25px; }
    #settings_video_format_menu .settings-item { display: flex; justify-content: space-between; align-items: center; }
    .settings-item select { background: var(--settings-item-bg); color: var(--text-light); border: 1px solid var(--border-color); border-radius: 4px; padding: 8px; font-size: 16px; }

    /* New EPG Styles */
    /* FIX: Make all text white in the EPG overlay */
    #epg_overlay { 
      z-index: 35; 
      background: rgba(0,0,0,0.85); 
      display: flex; 
      font-size: clamp(16px, 2vw, 20px); 
      color: var(--text-light); 
      /* NEW: Add transition and override fullscreen 'left' */
      transition: width 0.5s, left 0.5s;
      left: 0;
    }
    #epg_channels { width: clamp(280px, 22vw, 350px); height: 100%; overflow-y: auto; }
    #epg_timeline { flex-grow: 1; height: 100%; overflow-y: auto; border-left: 1px solid var(--border-color); }
    .epg-ch-item { padding: 12px 20px; white-space: normal; line-height: 1.3; height: auto; }
    #epg_timeline .epg-pr-item { padding: 20px; border-bottom: 1px solid var(--border-color); }
    /* FIX: Make EPG time text white */
    .epg-pr-time { color: var(--text-light); font-size: 0.9em; margin-bottom: 5px; }
    .epg-pr-title { font-weight: bold; }

    /* NEW: When Nav is visible, push EPG overlay to the right and shrink it */
    #nav.visible ~ #epg_overlay {
        left: var(--nav-width);
        width: calc(100% - var(--nav-width));
    }

    /* NEW: Codec Info Box Style */
    #codec_info {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 32; /* Above panels */
      background: rgba(0,0,0,0.7);
      color: var(--text-light);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 18px;
      text-shadow: 1px 1px 2px #000;
      opacity: 0; /* Hidden by default */
      transition: opacity 0.3s ease;
      pointer-events: none; /* Don't block clicks */
    }
    /* NEW: Show codec info when settings panel is visible */
    #channel_settings.visible ~ #codec_info {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="player_container">
      <video id="player" autoplay muted playsinline></video>
  </div>
  <div id="blur_overlay" class="fullscreen"></div>
  <div id="ui_elements">
    <div id="channel_loader_overlay" class="fullscreen HIDDEN">
      <div class="loader-content"><span class="loading-text">Loading Channel...</span><div class="loader-bar"></div></div>
    </div>
    <div id="idle_animation" class="fullscreen">
      <div class="idle-branding"><h1>SHAKZZ TV</h1><p>FOR FREE</p></div>
      <div id="play_button_overlay"><svg viewbox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg></div>
    </div>
    <div id="nav">
      <div id="brand-header">
        <svg viewbox="0 0 24 24" fill="white"><path d="M21,3H3C1.89,3,1,3.89,1,5V17C1,18.11,1.89,19,3,19H8V21H16V19H21C22.11,19,23,18.11,23,17V5C23,3.89,22.11,3,21,3M21,17H3V5H21V17M16,11L11,15V7L16,11Z"></path></svg>
        <span>Shakzz TV</span>
      </div>
      <div id="search_item_wrapper"><input id="search_field" type="search" placeholder="Search"></div>
      <div id="list_container_scrollarea" style="height: calc(100vh - 159px);">
        <div id="list_container">
          <div id="group_list" class="custom-scrollbar">
            <ul id="main_nav">
                <li id="guide_group">GUIDE</li>
                <li id="epg_button">EPG</li>
            </ul>
            <div class="HR" style="margin:16px 6px; height:1px; background: var(--primary-gradient);"></div>
            <h2 class="list_headline">CATEGORIES</h2>
            <ul id="dynamic_groups_list">
              <li data-group="__fav">FAVORITES</li>
              <li data-group="__all">ALL CHANNELS</li>
            </ul>
          </div>
          <div id="channel_list" class="custom-scrollbar"></div>
        </div>
      </div>
    </div>
    <div id="channel_settings">
      <div id="settings_container">
        <div id="settings_main_menu" class="custom-scrollbar"></div>
        <div id="settings_video_format_menu" class="custom-scrollbar"></div>
      </div>
    </div>
    <div id="channel_info">
      <div id="ch_logo"></div>
      <div id="channel_text_container">
        <div id="channel_name"></div>
        <div id="channel_epg"></div>
      </div>
    </div>
    <div id="guide" class="fullscreen HIDDEN" aria-hidden="true">
      <div class="fullscreen-popup" style="max-width:800px; padding: 30px;">
        <div class="close-button" onclick="hideGuide()"></div>
        <div id="guide_content"></div>
      </div>
    </div>
    <div id="epg_overlay" class="fullscreen HIDDEN" aria-hidden="true">
        <div id="epg_channels" class="custom-scrollbar"></div>
        <div id="epg_timeline" class="custom-scrollbar"></div>
    </div>
    <div id="settings_modal" class="fullscreen HIDDEN" aria-hidden="true">
        <div class="fullscreen-popup">
          <div id="settings_modal_content"></div>
        </div>
    </div>
    <div id="codec_info"></div>
  </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    /*******************************
     * Channels + Config
     *******************************/
    // FIX: Restored the full, correct channels object
    const channels = {
        KidoodleTV: { name: "Kidoodle TV", type: "hls", manifestUri: "https://amg07653-apmc-amg07653c5-samsung-ph-8539.playouts.now.amagi.tv/playlist.m3u8", logo: "https://d1iiooxwdowqwr.cloudfront.net/pub/appsubmissions/20201230211817_FullLogoColor4x.png", group: ["cartoons & animations"] },
        StrawberryShortcake: { name: "Strawberry Shortcake", type: "hls", manifestUri: "https://upload.wikimedia.org/wikipedia/en/f/ff/Strawberry_Shortcake_2003_Logo.png", logo: "https://upload.wikimedia.org/wikipedia/en/f/ff/Strawberry_Shortcake_2003_Logo.png", group: ["cartoons & animations"] },
        SonictheHedgehog: { name: "Sonic the Hedgehog", type: "hls", manifestUri: "https://d1si3n1st4nkgb.cloudfront.net/10000/88258004/hls/master.m3u8?ads.xumo_channelId=88258004", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1f/Sonic_The_Hedgehog.svg/1200px-Sonic_The_Hedgehog.svg.png", group: ["cartoons & animations"] },
        SuperMario: { name: "Super Mario", type: "hls", manifestUri: "https://d1si3n1st4nkgb.cloudfront.net/10000/88258005/hls/master.m3u8?ads.xumo_channelId=88258005", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRFkMkkUmZBGslGWGZMN2er5emlnqGCCU49wg&s", group: ["cartoons & animations"] },
        Teletubbies: { name: "Teletubbies", type: "hls", manifestUri: "httpsA1.amagi.tv/playlist.m3u8", logo: "https://www.medialink.com.hk/img/ani-one-logo.jpg", group: ["cartoons & animations"] },
        gma7: { name: "GMA 7", type: "clearkey", manifestUri: "https://vod.nathcreqtives.com/1093/manifest.mpd", keyId: "31363231383438333031323033393138", key: "38694e34324d543478316b7455753437", logo: "https://i.imgur.com/Cu1tAY8.png", group: ["news", "entertainment"] },
        jeepneytv: { name: "Jeepney TV", type: "clearkey", manifestUri: "https://abslive.akamaized.net/dash/live/2028025/jeepneytv/manifest.mpd", keyId: "90ea4079e02f418db7b170e8763e65f0", key: "1bfe2d166e31d03eee86ee568bd6c272", logo: "https://upload.wikimedia.org/wikipedia/en/1/15/Jeepney_TV_Logo_2015.svg", group: ["entertainment"] },
        aniplus: { name: "Aniplus", type: "hls", manifestUri: "https://amg18481-amg18481c1-amgplt0352.playout.now3.amagi.tv/playlist/amg18481-amg18481c1-amgplt0352/playlist.m3u8", logo: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSJj494OpI0bKrTrvcHqEkzMYzqtfLNdWjQrg&s", group: ["cartoons & animations"] },
        sinemanila: { name: "SineManila", type: "hls", manifestUri: "https://live20.bozztv.com/giatv/giatv-sinemanila/sinemanila/chunks.m3u8", logo: "https://is5-ssl.mzstatic.com/image/thumb/Purple112/v4/64/72/72/64727284-ad63-33a7-59a6-7975c742c038/AppIcon-0-0-1x_U007emarketing-0-0-0-5-0-0-sRGB-0-0-0-GLES2_U002c0-512MB-85-220-0-0.png/512x512bb.jpg", group: ["movies", "entertainment"] },
        pbarush: { name: "PBA Rush", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/cg_pbarush_hd1/default/index.mpd", keyId: "76dc29dd87a244aeab9e8b7c5da1e5f3", key: "95b2f2ffd4e14073620506213b62ac82", logo: "https://static.wikia.nocookie.net/logopedia/images/0/00/PBA_Rush_Logo_2016.png", group: ["entertainment"] },
        animalplanet: { name: "Animal Planet", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/cg_animal_planet_sd/default/index.mpd", keyId: "436b69f987924fcbbc06d40a69c2799a", key: "c63d5b0d7e52335b61aeba4f6537d54d", logo: "https://i.imgur.com/SkpFpW4.png", group: ["documentary"] },
        discoverychannel: { name: "Discovery Channel", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/discovery/default/index.mpd", keyId: "d9ac48f5131641a789328257e778ad3a", key: "b6e67c37239901980c6e37e0607ceee6", logo: "https://placehold.co/100x100/000/fff?text=Discovery", group: ["documentary"] },
        nickelodeon: { name: "Nickelodeon", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/dr_nickelodeon/default/index.mpd", keyId: "9ce58f37576b416381b6514a809bfd8b", key: "f0fbb758cdeeaddfa3eae538856b4d72", logo: "https://i.imgur.com/4o5dNZA.png", group: ["cartoons & animations"] },
        nickjr: { name: "Nick Jr", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/dr_nickjr/default/index.mpd", keyId: "bab5c11178b646749fbae87962bf5113", key: "0ac679aad3b9d619ac39ad634ec76bc8", logo: "https://i.imgur.com/iIVYdZP.png", group: ["cartoons & animations"] },
        pbo: { name: "PBO", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-01-prod.akamaized.net/bpk-tv/pbo_sd/default/index.mpd", keyId: "dcbdaaa6662d4188bdf97f9f0ca5e830", key: "31e752b441bd2972f2b98a4b1bc1c7a1", logo: "https://i.imgur.com/550RYpJ.png", group: ["movies", "entertainment"] },
        angrybirds: { name: "Angry Birds", type: "hls", manifestUri: "https://stream-us-east-1.getpublica.com/playlist.m3u8?network_id=547", logo: "https://www.pikpng.com/pngl/m/83-834869_angry-birds-theme-angry-birds-game-logo-png.png", group: ["cartoons & animations"] },
        zoomooasia: { name: "Zoo Moo Asia", type: "hls", manifestUri: "https://zoomoo-samsungau.amagi.tv/playlist.m3u8", logo: "https://ia803207.us.archive.org/32/items/zoo-moo-kids-2020_202006/ZooMoo-Kids-2020.png", group: ["cartoons & animations", "entertainment"] },
        mrbeanlive: { name: "MR Bean Live Action", type: "hls", manifestUri: "https://example.com/placeholder.m3u8", logo: "https://placehold.co/100x100/000/fff?text=Mr+Bean", group: ["entertainment"] },
        iQIYI: { name: "iQIYI", type: "clearkey", manifestUri: "https://linearjitp-playback.astro.com.my/dash-wv/linear/1006/default_ott.mpd", keyId: "placeholder", key: "placeholder", logo: "https://placehold.co/100x100/000/fff?text=iQIYI", group: ["entertainment"] },
        tv5: { name: "TV 5 HD", type: "clearkey", manifestUri: "https://qp-pldt-live-bpk-02-prod.akamaized.net/bpk-tv/tv5_hd/default1/index.mpd", keyId: "2615129ef2c846a9bbd43a641c7303ef", key: "07c7f996b1734ea288641a68e1cfdc4d", logo: "https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/TV5_logo.svg/1200px-TV5_logo.svg.png", group: ["news", "entertainment"] },
        kapamilya: { name: "Kapamilya Channel HD", type: "clearkey", manifestUri: "https://d1uf7s78uqso1e.cloudfront.net/out/v1/efa01372657648be830e7c23ff68bea2/index.mpd", keyId: "bd17afb5dc9648a39be79ee3634dd4b8", key: "3ecf305d54a7729299b93a3d69c02ea5", logo: "https://placehold.co/100x100/000/fff?text=Kapamilya", group: ["entertainment"] },
    };
    
    // --- State Variables ---
    let player, ui, iCurrentChannel = 0, iGroupListIndex = 3, iChannelSettingsIndex = 0, iVideoSettingsIndex = 0, iEpgChannelIndex = 0;
    let aFilteredChannelKeys = [], sSelectedGroup = '__all';
    let bNavOpened = false, bGroupsOpened = false, bGuideOpened = false, bChannelSettingsOpened = false, bSettingsModalOpened = false, bEpgOpened = false;
    let channelNameTimeout, isSessionActive = false;
    let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;

    // --- DOM Element Cache ---
    const getEl = id => document.getElementById(id);
    const o = {
        AvPlayer: getEl("player"), PlayerContainer: getEl("player_container"), Nav: getEl("nav"), BlurOverlay: getEl("blur_overlay"),
        ChannelSettings: getEl("channel_settings"), SettingsContainer: getEl("settings_container"),
        SettingsMainMenu: getEl("settings_main_menu"), SettingsVideoFormatMenu: getEl("settings_video_format_menu"),
        ChannelList: getEl("channel_list"), ChannelInfo: getEl("channel_info"),
        Guide: getEl("guide"), GuideContent: getEl("guide_content"), SearchField: getEl("search_field"), IdleAnimation: getEl("idle_animation"),
        PlayButton: getEl("play_button_overlay"), ChannelLoader: getEl("channel_loader_overlay"),
        GroupList: getEl("group_list"), ListContainer: getEl("list_container"), DynamicGroupsList: getEl('dynamic_groups_list'),
        SettingsModal: getEl("settings_modal"), SettingsModalContent: getEl("settings_modal_content"),
        EpgOverlay: getEl("epg_overlay"), EpgChannels: getEl("epg_channels"), EpgTimeline: getEl("epg_timeline"),
        // NEW: Codec Info Cache
        CodecInfo: getEl("codec_info")
    };

    // --- Core Player Functions ---
    async function initPlayer() {
        Object.keys(channels).forEach((key, i) => { channels[key].number = i + 1; channels[key].key = key; });
        loadFavoritesFromStorage();
        setupMainMenuControls();
        buildDynamicGroupNav();
        sSelectedGroup = '__all';
        buildNav();
        updateSelectedGroupInNav();
        
        await shaka.polyfill.installAll();
        if (!shaka.Player.isBrowserSupported()) { console.error("Browser not supported"); return; }
        
        player = new shaka.Player();
        ui = new shaka.ui.Overlay(player, o.PlayerContainer, o.AvPlayer);
        ui.getControls(); // This creates the controls
        player.attach(o.AvPlayer);

        player.configure({ abr: { defaultBandwidthEstimate: 500000 }, streaming: { rebufferingGoal: 2, bufferingGoal: 8 } });
        player.addEventListener('error', e => { console.error('Shaka Error:', e.detail); showIdleAnimation(true); });
        
        loadInitialChannel();
    }

    function loadInitialChannel() {
        const storedLast = localStorage.getItem('iptvLastWatched');
        let initialChannelKey = 'aniplus';
        if (storedLast && channels[storedLast]) initialChannelKey = storedLast;
        const initialIndex = aFilteredChannelKeys.indexOf(initialChannelKey);
        loadChannel(initialIndex >= 0 ? initialIndex : 0, { isInitialLoad: true });
    }

    async function loadChannel(index, options = {}) {
        if (!aFilteredChannelKeys.length) { player?.unload(); showIdleAnimation(true); return; }
        iCurrentChannel = (index < 0) ? aFilteredChannelKeys.length - 1 : index % aFilteredChannelKeys.length;
        const channelKey = aFilteredChannelKeys[iCurrentChannel];
        const channel = channels[channelKey];
        if (!player || !channel) return;
        localStorage.setItem('iptvLastWatched', channelKey);
        if (!options.isInitialLoad) {
            o.ChannelLoader.classList.remove('HIDDEN');
            o.BlurOverlay.classList.add('visible');
        }
        showChannelName();
        updateSelectedChannelInNav();
        try {
            player.configure('drm.clearKeys', {});
            if (channel.type === 'clearkey' && channel.keyId && channel.key) {
                player.configure({ drm: { clearKeys: { [channel.keyId]: channel.key } } });
            }
            player.getNetworkingEngine()?.clearAllRequestFilters();
            if (channel.userAgent) {
                player.getNetworkingEngine()?.registerRequestFilter((type, request) => { request.headers['User-Agent'] = channel.userAgent; });
            }
            await player.load(channel.manifestUri);
            if (isSessionActive) { hideIdleAnimation(); o.AvPlayer.muted = false; }
        } catch (error) {
            console.error(`Error loading: ${channel?.name}`, error);
            if (!options.isInitialLoad) showIdleAnimation(true);
        } finally {
            if (!options.isInitialLoad) {
                o.ChannelLoader.classList.add('HIDDEN');
                o.BlurOverlay.classList.remove('visible');
            }
        }
    }

    // --- UI and Navigation ---
    function setupMainMenuControls() {
        getEl('guide_group').onclick = showGuide;
        getEl('epg_button').onclick = showEpg;
    }

    function buildDynamicGroupNav() {
        const allGroups = new Set(Object.values(channels).flatMap(ch => ch.group || []));
        const sortedGroups = [...allGroups].sort();
        let groupHtml = '';
        sortedGroups.forEach(name => { groupHtml += `<li data-group="${name}">${name.toUpperCase()}</li>`; });
        o.DynamicGroupsList.insertAdjacentHTML('beforeend', groupHtml);
        o.GroupList.querySelectorAll('li[data-group]').forEach((li, index) => {
            li.onclick = () => selectGroup(index + 2); // 2 for static items
        });
    }

    // FIX: Removed setTimeout for faster category switching
    function selectGroup(index) {
        const item = o.GroupList.querySelectorAll('li')[index];
        if (!item || !item.hasAttribute('data-group')) return;
        iGroupListIndex = index;
        updateSelectedGroupInNav();
        sSelectedGroup = item.dataset.group;
        hideGroups();
        
        iCurrentChannel = 0; // FIX: Reset channel index to 0 for new category
        buildNav();
        if (aFilteredChannelKeys.length === 0) { player?.unload(); showIdleAnimation(true); }
    }
    
    function buildNav() {
        const searchTerm = o.SearchField.value.toLowerCase();
        aFilteredChannelKeys = Object.keys(channels).filter(key => {
            const ch = channels[key];
            const inGroup = sSelectedGroup === '__all' || (sSelectedGroup === '__fav' && ch.favorite) || (ch.group && ch.group.includes(sSelectedGroup));
            const inSearch = !searchTerm || ch.name.toLowerCase().includes(searchTerm);
            return inGroup && inSearch;
        }).sort((a, b) => channels[a].number - channels[b].number);
        
        o.ChannelList.innerHTML = '';
        o.ChannelList.scrollTop = 0; // FIX: Scroll list to top on rebuild
        
        if (aFilteredChannelKeys.length === 0) { o.ChannelList.innerHTML = `<li style="justify-content:center; color:#888;">No channels found.</li>`; return; }
        const frag = document.createDocumentFragment();
        aFilteredChannelKeys.forEach((key, index) => {
            const ch = channels[key];
            const item = document.createElement('li');
            item.className = 'channel-item';
            item.onclick = () => { loadChannel(index); setTimeout(hideNav, 100); };
            const fav = ch.favorite ? `<span class="fav-star">⭐</span>` : '';
            const logo = ch.logo ? `<div class="nav_logo"><img src="${ch.logo}" alt=""></div>` : '';
            item.innerHTML = `${fav}<span class="list-ch">${ch.number}</span><span class="list-title">${ch.name}</span>${logo}`;
            frag.appendChild(item);
        });
        o.ChannelList.appendChild(frag);
        updateSelectedChannelInNav();
    }
    
    function updateSelectedChannelInNav() {
        o.ChannelList.querySelector('.selected')?.classList.remove('selected');
        const newItem = o.ChannelList.querySelectorAll('li.channel-item')[iCurrentChannel];
        if (newItem) { newItem.classList.add('selected'); if (bNavOpened) newItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }
    
    function updateSelectedGroupInNav() {
        o.GroupList.querySelector('.selected')?.classList.remove('selected');
        const newItem = o.GroupList.querySelectorAll('li')[iGroupListIndex];
        if (newItem) { newItem.classList.add('selected'); if(bGroupsOpened) newItem.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    }

    // --- Settings Panels & Modals ---
    
    // FIX: Updated function to populate the new codec info box and remove extra buttons
    function renderChannelSettings() {
        const currentChannel = channels[aFilteredChannelKeys[iCurrentChannel]];
        if (!currentChannel) return;

        // --- Get Codec Info ---
        const activeTracks = player.getActiveTracks();
        let vCodec = 'N/A';
        let aCodec = 'N/A';

        if (activeTracks) {
            if (activeTracks.video) {
                vCodec = activeTracks.video.codec.split('.')[0].toUpperCase();
            }
            if (activeTracks.audio) {
                aCodec = activeTracks.audio.codec.split('.')[0].toUpperCase();
            }
        }
        // Update the new codec info element
        o.CodecInfo.textContent = `Video: ${vCodec} | Audio: ${aCodec}`;
        // --- End Codec Info ---

        // Render the main menu
        o.SettingsMainMenu.innerHTML = `
            <div class="settings-item" onclick="showSettingsModal('subtitles')">Subtitle / Audio</div>
            <div class="settings-item" onclick="showVideoFormatMenu()">Video / Format</div>
            <div class="settings-item" onclick="toggleFavourite()">${currentChannel.favorite ? 'Remove from Favorites' : 'Add to Favorites'}</div>
        `;
        updateSettingsSelection(o.SettingsMainMenu, iChannelSettingsIndex);
    }

    function showVideoFormatMenu() { o.SettingsContainer.classList.add('submenu-visible'); iVideoSettingsIndex = 0; renderVideoFormatMenu(); }
    function hideVideoFormatMenu() { o.SettingsContainer.classList.remove('submenu-visible'); iChannelSettingsIndex = 1; updateSettingsSelection(o.SettingsMainMenu, iChannelSettingsIndex); }
    
    function renderVideoFormatMenu() {
        o.SettingsVideoFormatMenu.innerHTML = `
            <div class="settings-item" onclick="hideVideoFormatMenu()">&#8592; Back</div>
            <div class="settings-item-header">Video Format</div>
            <div class="settings-item">
                <span>Video format</span>
                <select onchange="setAspectRatio(this.value)">
                    <option value="original">Original</option>
                    <option value="16:9">16:9</option>
                    <option value="stretch">Stretch</option>
                    <option value="zoom">Zoom</option>
                </select>
            </div>
            <div class="settings-item" onclick="showSettingsModal('quality')">Video track</div>
        `;
        updateSettingsSelection(o.SettingsVideoFormatMenu, iVideoSettingsIndex);
    }

    function setAspectRatio(format) {
        o.AvPlayer.style.transform = 'scale(1)';
        switch(format) {
            case 'stretch': o.AvPlayer.style.objectFit = 'fill'; break;
            case '16:9': o.AvPlayer.style.objectFit = 'contain'; break;
            case 'zoom': o.AvPlayer.style.objectFit = 'cover'; o.AvPlayer.style.transform = 'scale(1.15)'; break;
            default: o.AvPlayer.style.objectFit = 'contain';
        }
    }

    function togglePlaybackControls() {
        ui.getControls().getControlsContainer().removeAttribute('hidden');
        ui.getControls().overrideCssShowControls(true);
        setTimeout(() => { ui.getControls().overrideCssShowControls(false); }, 5000);
        hideChannelSettings();
    }

    function showSettingsModal(type) {
        clearUi('settingsModal'); o.BlurOverlay.classList.add('visible'); bSettingsModalOpened = true;
        o.SettingsModalContent.innerHTML = renderModalContent(type);
        o.SettingsModal.classList.remove('HIDDEN');
    }
    window.hideSettingsModal = () => {
        bSettingsModalOpened = false; o.SettingsModal.classList.add('HIDDEN'); o.BlurOverlay.classList.remove('visible');
    }

    function renderModalContent(type) {
        let contentHtml = '';
        if (type === 'quality') {
            const tracks = [...new Map((player?.getVariantTracks() || []).filter(t => t.height).map(t => [t.height, t])).values()].sort((a, b) => b.height - a.height);
            let itemsHtml = `<li onclick="this.querySelector('input').checked=true">Auto <input type="radio" name="quality" value="auto" ${player.getConfiguration().abr.enabled ? 'checked' : ''}></li>`;
            tracks.forEach(track => {
                const bps = track.bandwidth > 1000000 ? `${(track.bandwidth/1e6).toFixed(2)} Mbps` : `${Math.round(track.bandwidth/1e3)} Kbps`;
                itemsHtml += `<li onclick="this.querySelector('input').checked=true">${track.height}p, ${bps} <input type="radio" name="quality" value='${track.id}' ${track.active && !player.getConfiguration().abr.enabled ? 'checked' : ''}></li>`;
            });
            contentHtml = `<h2>Quality</h2><ul class="popup-content-list">${itemsHtml}</ul>
            <div class="popup-buttons"><button onclick="hideSettingsModal()">CANCEL</button><button onclick="applyQualitySetting()">OK</button></div>`;
        } else if (type === 'subtitles') {
            const textTracks = player?.getTextTracks() || [];
            const audioTracks = player?.getAudioLanguagesAndRoles() || [];
            let subItemsHtml = `<li onclick="setSubtitles(null, false)">Off</li>`;
            textTracks.forEach(track => { subItemsHtml += `<li onclick='setSubtitles(${JSON.stringify(track)}, true)'>${track.label || track.language}</li>`; });
            let audioItemsHtml = audioTracks.map(track => `<li onclick="setAudio('${track.language}')">${track.language} (Audio)</li>`).join('');
            contentHtml = `<h2>Subtitles & Audio</h2><ul class="popup-content-list">${subItemsHtml}${audioItemsHtml}</ul><div class="popup-buttons"><button onclick="hideSettingsModal()">CLOSE</button></div>`;
        } else if (type === 'edit') {
            const currentChannel = channels[aFilteredChannelKeys[iCurrentChannel]];
            contentHtml = `<h2>Edit Channel</h2><div style="padding: 15px 25px;">
            <label>Name</label><br><input type="text" id="edit_ch_name" class="edit-modal-field" value="${currentChannel.name}"><br>
            <label>Logo URL</label><br><input type="text" id="edit_ch_logo" class="edit-modal-field" value="${currentChannel.logo || ''}">
            </div><div class="popup-buttons"><button onclick="hideSettingsModal()">CANCEL</button><button onclick="applyChannelEdit()">SAVE</button></div>`;
        }
        return contentHtml;
    }

    window.applyChannelEdit = () => {
      const key = aFilteredChannelKeys[iCurrentChannel];
      channels[key].name = getEl('edit_ch_name').value;
      channels[key].logo = getEl('edit_ch_logo').value;
      buildNav(); // Rebuild list to show changes
      hideSettingsModal();
    };

    window.applyQualitySetting = () => {
        const selected = document.querySelector('input[name="quality"]:checked').value;
        if(selected === 'auto') { player.configure({ abr: { enabled: true } }); } 
        else {
            player.configure({ abr: { enabled: false } });
            const trackToSelect = player.getVariantTracks().find(t => t.id == selected);
            if (trackToSelect) player.selectVariantTrack(trackToSelect, true);
        }
        hideSettingsModal();
    }
    window.setSubtitles = (track, isVisible) => { player.setTextTrackVisibility(isVisible); if (track) { const trackToSelect = player.getTextTracks().find(t => t.id === track.id); if (trackToSelect) player.selectTextTrack(trackToSelect); } hideSettingsModal(); };
    window.setAudio = lang => { player.selectAudioLanguage(lang); hideSettingsModal(); };
    
    function toggleFavourite() {
        const key = aFilteredChannelKeys[iCurrentChannel]; if (!key) return;
        channels[key].favorite = !channels[key].favorite;
        saveFavoritesToStorage(); renderChannelSettings();
    }
    
    // --- UI State & Helpers ---
    function showIdleAnimation(showPlayButton = false) { o.IdleAnimation.classList.remove('HIDDEN'); if (showPlayButton && !isSessionActive) { o.PlayButton.classList.remove('HIDDEN'); } else { o.PlayButton.classList.add('HIDDEN'); } }
    function hideIdleAnimation() { o.IdleAnimation.classList.add('HIDDEN'); isSessionActive = true; }
    
    // FIX: Modified logic to prevent hiding nav when EPG or Guide is opened from it
    function clearUi(exclude) { 
        // If we are excluding 'epg' or 'guide', it means we are OPENING them,
        // and they are opened FROM the nav panel. So, don't hide nav.
        if (exclude !== 'nav' && exclude !== 'epg' && exclude !== 'guide') {
            hideNav(); 
        }
        if (exclude !== 'channelSettings') hideChannelSettings(); 
        if (exclude !== 'guide') hideGuide(); 
        if (exclude !== 'channelName') hideChannelName(); 
        if (exclude !== 'settingsModal') hideSettingsModal(); 
        if (exclude !== 'epg') hideEpg(); 
    }

    function showNav() { clearUi('nav'); bNavOpened = true; o.Nav.classList.add('visible'); }
    function hideNav() { bNavOpened = bGroupsOpened = false; o.Nav.classList.remove('visible'); }
    function showGroups() { if(bNavOpened) { bGroupsOpened = true; o.ListContainer.classList.add('groups-opened'); updateSelectedGroupInNav(); } }
    function hideGroups() { bGroupsOpened = false; o.ListContainer.classList.remove('groups-opened'); }
    function showChannelSettings() { clearUi('channelSettings'); hideVideoFormatMenu(); iChannelSettingsIndex = 0; renderChannelSettings(); bChannelSettingsOpened = true; o.ChannelSettings.classList.add('visible'); }
    
    // FIX: Updated to clear codec info when panel closes
    function hideChannelSettings() {
        bChannelSettingsOpened = false;
        o.ChannelSettings.classList.remove('visible');
        o.CodecInfo.textContent = ''; // Clear the codec info
    }

    window.showGuide = () => { clearUi('guide'); o.BlurOverlay.classList.add('visible'); renderGuideContent(); bGuideOpened = true; o.Guide.classList.remove('HIDDEN'); }
    window.hideGuide = () => { bGuideOpened = false; o.Guide.classList.add('HIDDEN'); o.BlurOverlay.classList.remove('visible'); }
    function renderGuideContent() { o.GuideContent.innerHTML = `<h2>Controls</h2><ul style="list-style: none; padding: 0; font-size: clamp(16px, 2.5vw, 22px); line-height: 1.8;"><li><kbd>M</kbd> - Settings</li><li><kbd>E</kbd> - EPG</li><li><kbd>H</kbd> - User Manual</li><li><kbd>↑</kbd>/<kbd>↓</kbd> - Change channel</li><li><kbd>←</kbd> - open channel list</li><li><kbd>←</kbd><kbd>←</kbd> - open group list</li><li><kbd>→</kbd> - open channel settings</li><li><kbd>OK</kbd>/<kbd>Enter</kbd> - Show info</li><li><kbd>ESC</kbd> - Go Back</li></ul>`; }

    // --- EPG Functions ---
    function showEpg() { clearUi('epg'); iEpgChannelIndex = iCurrentChannel; renderEpg(); bEpgOpened = true; o.EpgOverlay.classList.remove('HIDDEN'); }
    function hideEpg() { bEpgOpened = false; o.EpgOverlay.classList.add('HIDDEN'); }
    function renderEpg() {
        let channelsHtml = '';
        aFilteredChannelKeys.forEach((key, index) => {
            const ch = channels[key];
            const selectedClass = index === iEpgChannelIndex ? 'selected' : '';
            channelsHtml += `<div class="epg-ch-item ${selectedClass}">${ch.number}. ${ch.name}</div>`;
        });
        o.EpgChannels.innerHTML = channelsHtml;
        o.EpgTimeline.innerHTML = generateDummyEpg();
        o.EpgChannels.querySelector('.selected')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    function generateDummyEpg() {
        // FIX: Corrected broken class attribute
        return `<div class="epg-pr-item"><div class="epg-pr-time">Now Playing</div><div class="epg-pr-title">Current Program Title</div></div><div class="epg-pr-item"><div class="epg-pr-time">Up Next</div><div class="epg-pr-title">The Next Exciting Show</div></div><div class="epg-pr-item"><div class="epg-pr-time">Later</div><div class="epg-pr-title">Evening Special</div></div>`;
    }

    function showChannelName() { clearTimeout(channelNameTimeout); if (!aFilteredChannelKeys.length) return; const ch = channels[aFilteredChannelKeys[iCurrentChannel]]; if (!ch) return; getEl('channel_name').textContent = ch.name; getEl('channel_epg').textContent = 'EPG not available'; getEl('ch_logo').innerHTML = ch.logo ? `<img src="${ch.logo}" alt="${ch.name} logo">` : ''; o.ChannelInfo.classList.add('visible'); channelNameTimeout = setTimeout(hideChannelName, 5000); }
    function hideChannelName() { o.ChannelInfo.classList.remove('visible'); }
    function loadFavoritesFromStorage() { try { const favs = JSON.parse(localStorage.getItem("iptvFavoriteChannels") || "[]"); Object.keys(channels).forEach(key => channels[key].favorite = favs.includes(key)); } catch(e) {} }
    function saveFavoritesToStorage() { try { const favs = Object.entries(channels).filter(([,ch]) => ch.favorite).map(([key]) => key); localStorage.setItem("iptvFavoriteChannels", JSON.stringify(favs)); } catch(e) {} }
    
    function handleFirstPlay() { 
        // FIX: Prevent function from running more than once
        if (isSessionActive) return;
        isSessionActive = true; 
        
        // FIX: Directly hide the idle animation screen here
        o.IdleAnimation.classList.add('HIDDEN');
        
        o.AvPlayer.muted = false; 
        o.AvPlayer.play().catch(e => console.warn("Autoplay was prevented.", e)); 
        // o.PlayButton.classList.add('HIDDEN'); // This is no longer needed, as the parent is hidden
    }

    // FIX: Restored missing function body
    function updateSettingsSelection(container, index) {
        container.querySelector('.selected')?.classList.remove('selected');
        const items = container.querySelectorAll('.settings-item');
        if (items[index]) {
            items[index].classList.add('selected');
            items[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // --- Event Listeners ---
    // FIX: Changed event from 'click' to 'mousedown' for better reliability
    o.PlayButton.addEventListener('mousedown', handleFirstPlay);
    o.SearchField.addEventListener('input', () => { buildNav(); if (aFilteredChannelKeys.length > 0) { if(isSessionActive) loadChannel(0); } else { player?.unload(); showIdleAnimation(true); } });
    
    document.addEventListener('keydown', (e) => {
        if (document.activeElement === o.SearchField || bSettingsModalOpened) return;
        
        if (bEpgOpened) {
            e.preventDefault();
            const items = o.EpgChannels.querySelectorAll('.epg-ch-item');
            if (e.key === 'Escape') hideEpg();
            else if (e.key === 'ArrowUp') iEpgChannelIndex = Math.max(0, iEpgChannelIndex - 1);
            else if (e.key === 'ArrowDown') iEpgChannelIndex = Math.min(items.length - 1, iEpgChannelIndex + 1);
            renderEpg();
        } else if (bGuideOpened) {
             if (e.key === 'Escape') hideGuide();
        } else if (bNavOpened) {
            e.preventDefault();
            if (bGroupsOpened) {
                const groupItems = o.GroupList.querySelectorAll('li');
                if (e.key === 'ArrowUp') iGroupListIndex = Math.max(0, iGroupListIndex - 1);
                else if (e.key === 'ArrowDown') iGroupListIndex = Math.min(groupItems.length - 1, iGroupListIndex + 1);
                else if (e.key === 'Enter') groupItems[iGroupListIndex]?.click();
                else if (e.key === 'ArrowRight' || e.key === 'Escape') hideGroups();
                updateSelectedGroupInNav();
            } else {
                if (e.key === 'ArrowUp') iCurrentChannel = (iCurrentChannel - 1 + aFilteredChannelKeys.length) % aFilteredChannelKeys.length;
                else if (e.key === 'ArrowDown') iCurrentChannel = (iCurrentChannel + 1) % aFilteredChannelKeys.length;
                else if (e.key === 'Enter') { loadChannel(iCurrentChannel); hideNav(); }
                else if (e.key === 'ArrowRight' || e.key === 'Escape') hideNav();
                else if (e.key === 'ArrowLeft') showGroups();
                updateSelectedChannelInNav();
            }
        } else if (bChannelSettingsOpened) {
            e.preventDefault();
            const isSubmenu = o.SettingsContainer.classList.contains('submenu-visible');
            if (isSubmenu) {
                const items = o.SettingsVideoFormatMenu.querySelectorAll('.settings-item');
                if (e.key === 'ArrowUp') iVideoSettingsIndex = Math.max(0, iVideoSettingsIndex - 1);
                else if (e.key === 'ArrowDown') iVideoSettingsIndex = Math.min(items.length - 1, iVideoSettingsIndex + 1);
                else if (e.key === 'Enter') items[iVideoSettingsIndex]?.click();
                else if (e.key === 'ArrowLeft' || e.key === 'Escape') hideVideoFormatMenu();
                updateSettingsSelection(o.SettingsVideoFormatMenu, iVideoSettingsIndex);
            } else {
                const items = o.SettingsMainMenu.querySelectorAll('.settings-item');
                if (e.key === 'ArrowUp') iChannelSettingsIndex = Math.max(0, iChannelSettingsIndex - 1);
                else if (e.key === 'ArrowDown') iChannelSettingsIndex = Math.min(items.length - 1, iChannelSettingsIndex + 1);
                else if (e.key === 'Enter' || e.key === 'ArrowRight') items[iChannelSettingsIndex]?.click();
                else if (e.key === 'ArrowLeft' || e.key === 'Escape') hideChannelSettings();
                updateSettingsSelection(o.SettingsMainMenu, iChannelSettingsIndex);
            }
        } else {
            switch (e.key) {
                case 'ArrowLeft': e.preventDefault(); showNav(); break;
                case 'ArrowRight': e.preventDefault(); showChannelSettings(); break;
                case 'Enter': e.preventDefault(); showChannelName(); break;
                case 'ArrowUp': e.preventDefault(); loadChannel(iCurrentChannel - 1); break;
                case 'ArrowDown': e.preventDefault(); loadChannel(iCurrentChannel + 1); break;
                case 'h': e.preventDefault(); showGuide(); break;
                case 'e': e.preventDefault(); showEpg(); break;
                case 'Escape': e.preventDefault(); clearUi(); break;
            }
        }
    });

    document.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; });
    document.addEventListener('touchmove', e => { touchEndX = e.touches[0].clientX; touchEndY = e.touches[0].clientY; });
    document.addEventListener('touchend', () => {
        const deltaX = touchEndX - touchStartX; const deltaY = touchEndY - touchStartY;
        const isHorizontal = Math.abs(deltaX) > Math.abs(deltaY);
        if (isHorizontal && Math.abs(deltaX) > 50) {
            if (deltaX > 0) { if (bChannelSettingsOpened) hideChannelSettings(); else showNav(); } 
            else { if (bNavOpened) hideNav(); else showChannelSettings(); }
        } else if (!isHorizontal && Math.abs(deltaY) > 50) {
            if (!bNavOpened && !bChannelSettingsOpened && !bGuideOpened) { if (deltaY > 0) loadChannel(iCurrentChannel + 1); else loadChannel(iCurrentChannel - 1); }
        } else if (Math.abs(deltaX) < 10 && Math.abs(deltaY) < 10) {
            if (!bNavOpened && !bChannelSettingsOpened && !bGuideOpened) showChannelName();
        }
    });
    initPlayer();
});
</script>
</body>
</html>
te,keyboard, and mouse and touch screen(android)
